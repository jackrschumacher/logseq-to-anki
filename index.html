<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Logseq to Anki</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            /* Default Dark Theme */
            --bg: #0f172a;
            --surface: #1e293b;
            --border: #334155;
            --text: #e2e8f0;
            --text-muted: #94a3b8;
            --accent: #3b82f6;
            --green: #10b981;
            --orange: #f59e0b;
            --red: #ef4444;
            --purple: #8b5cf6;
            --pink: #ec4899;
            --sidebar-width: 220px;
            --header-bg: rgba(0, 0, 0, 0.2);
            --input-area-bg: #162032;
            --scroll-thumb: #475569;
            --hover-bg: rgba(255, 255, 255, 0.05);
            --focus-glow: rgba(59, 130, 246, 0.25);
        }

        /* Light Theme Overrides */
        [data-theme="light"] {
            --bg: #f8fafc;
            /* Slate 50 */
            --surface: #ffffff;
            /* White */
            --border: #cbd5e1;
            /* Slate 300 */
            --text: #0f172a;
            /* Slate 900 */
            --text-muted: #64748b;
            /* Slate 500 */
            --accent: #2563eb;
            /* Blue 600 */
            --header-bg: rgba(0, 0, 0, 0.03);
            --input-area-bg: #f1f5f9;
            /* Slate 100 */
            --scroll-thumb: #cbd5e1;
            --hover-bg: rgba(0, 0, 0, 0.05);
            --focus-glow: rgba(37, 99, 235, 0.2);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* --- LAYOUT UTILS --- */
        button {
            cursor: pointer;
            transition: 0.2s;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--scroll-thumb);
        }

        /* --- TOP BAR --- */
        .top-bar {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 0 20px;
            height: 50px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .controls-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            background: var(--hover-bg);
            padding: 4px 10px;
            border-radius: 20px;
            cursor: pointer;
            user-select: none;
            border: 1px solid var(--border);
        }

        .status-badge {
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 4px;
            background: var(--border);
            color: var(--text-muted);
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-badge.active {
            background: rgba(16, 185, 129, 0.2);
            color: var(--green);
        }

        .pulse {
            width: 8px;
            height: 8px;
            background: currentColor;
            border-radius: 50%;
        }

        /* --- WORKSPACE (RESPONSIVE GRID) --- */
        .workspace {
            display: grid;
            grid-template-columns: var(--sidebar-width) 1fr 320px 240px;
            grid-template-rows: 1fr;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }

        @media (max-width: 1200px) {
            .workspace {
                grid-template-columns: 250px 1fr;
                grid-template-rows: 1fr 1fr;
            }

            .pane {
                border-bottom: 1px solid var(--border);
            }
        }

        @media (max-width: 768px) {
            body {
                overflow: auto;
                height: auto;
            }

            .workspace {
                display: flex;
                flex-direction: column;
                overflow: visible;
                height: auto;
            }

            .pane {
                height: 500px;
                border-right: none;
                border-bottom: 4px solid var(--bg);
            }

            .pane:nth-child(2) {
                height: 600px;
            }

            .top-bar {
                padding: 10px;
                flex-wrap: wrap;
                height: auto;
                gap: 10px;
            }

            .controls-left {
                flex-wrap: wrap;
            }
        }

        .pane {
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }

        .pane:last-child {
            border-right: none;
        }

        .pane-header {
            padding: 10px;
            background: var(--header-bg);
            border-bottom: 1px solid var(--border);
            font-size: 0.75rem;
            font-weight: bold;
            color: var(--text-muted);
            text-transform: uppercase;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        /* --- COLUMNS & SEARCH --- */
        .search-box {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            background: var(--surface);
        }

        .search-wrapper {
            position: relative;
            width: 100%;
        }

        .search-icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            pointer-events: none;
            font-size: 0.85rem;
            opacity: 0.8;
        }

        .search-box input {
            width: 100%;
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 8px 10px 8px 32px;
            /* Left padding space for icon */
            border-radius: 6px;
            font-size: 0.85rem;
            transition: all 0.2s ease;
            box-sizing: border-box;
        }

        .search-box input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--focus-glow);
            outline: none;
        }

        .search-box input::placeholder {
            color: var(--text-muted);
            opacity: 0.7;
        }

        .file-list {
            flex: 1;
            overflow-y: auto;
        }

        .file-item {
            padding: 8px 15px;
            cursor: pointer;
            font-size: 0.85rem;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text-muted);
        }

        .file-item:hover {
            background: var(--hover-bg);
            color: var(--text);
        }

        .file-item.selected {
            background: var(--accent);
            color: white;
        }

        #sourceWrapper {
            flex: 1;
            overflow-y: auto;
            position: relative;
        }

        #sourceEditor {
            padding: 20px;
            outline: none;
            line-height: 1.8;
            white-space: pre-wrap;
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
        }

        /* Improved Image Preview Style */
        #sourceEditor img {
            max-width: 85%;
            max-height: 500px;
            display: block;
            margin: 20px auto;
            border-radius: 6px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            background-color: white;
        }

        .suggestion {
            border-bottom: 1px dashed var(--orange);
            cursor: pointer;
            color: var(--text);
        }

        .suggestion:hover {
            background: rgba(245, 158, 11, 0.2);
        }

        .auto-card {
            border-bottom: 2px dashed var(--green);
            cursor: pointer;
            color: var(--green);
        }

        .auto-card:hover {
            background: rgba(16, 185, 129, 0.15);
        }

        .workbench-split {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }

        .input-area {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: var(--input-area-bg);
            flex-shrink: 0;
        }

        .draft-area {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background: var(--bg);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        textarea {
            width: 100%;
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 4px;
            padding: 8px;
            min-height: 70px;
            resize: vertical;
            font-family: inherit;
            box-sizing: border-box;
        }

        textarea:focus {
            border-color: var(--accent);
            outline: none;
        }

        .btn-stage {
            background: var(--surface);
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            transition: 0.2s;
        }

        .btn-stage:hover {
            background: var(--accent);
            color: white;
        }

        .btn-ai {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 0.75rem;
            transition: opacity 0.2s;
            position: relative;
            overflow: hidden;
        }

        .btn-ai:hover {
            opacity: 0.9;
        }

        .btn-ai.loading {
            opacity: 0.8;
            cursor: wait;
            pointer-events: none;
        }

        .ai-progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: #34d399;
            width: 0%;
            transition: width 0.5s ease-out;
            box-shadow: 0 0 10px rgba(52, 211, 153, 0.7);
        }

        .btn-commit-all {
            background: var(--green);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
            width: 100%;
        }

        .btn-commit-all:hover {
            background: #059669;
        }

        .draft-item {
            background: var(--surface);
            border: 1px solid var(--border);
            border-left: 3px solid var(--orange);
            border-radius: 4px;
            padding: 10px;
        }

        .draft-actions {
            margin-top: 8px;
            display: flex;
            gap: 5px;
            justify-content: flex-end;
        }

        .mini-btn {
            font-size: 0.7rem;
            padding: 4px 8px;
            border-radius: 3px;
            border: none;
            cursor: pointer;
        }

        .btn-push {
            background: var(--green);
            color: white;
        }

        .btn-del {
            background: var(--red);
            color: white;
        }

        .card-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .saved-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 8px;
            position: relative;
            font-size: 0.85rem;
            opacity: 0.8;
        }

        .clear-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 1rem;
            padding: 4px;
            border-radius: 4px;
        }

        .clear-btn:hover {
            background: rgba(239, 68, 68, 0.1);
            color: var(--red);
        }

        /* --- FOOTER & MODALS --- */
        .footer-bar {
            height: 30px;
            background: var(--surface);
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 15px;
            font-size: 0.75rem;
            color: var(--text-muted);
            justify-content: space-between;
            flex-shrink: 0;
            user-select: none;
            position: sticky;
            bottom: 0;
            z-index: 100;
        }

        .stat-group {
            display: flex;
            gap: 20px;
        }

        .stat-item {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .stat-value {
            color: var(--text);
            font-weight: 600;
            font-family: monospace;
        }

        .stat-divider {
            width: 1px;
            height: 14px;
            background: var(--border);
        }

        /* Generic Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            width: 900px;
            max-width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            color: var(--text);
        }

        .modal-small {
            width: 500px;
        }

        /* Smaller variant */

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--text);
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .stat-card-num {
            font-size: 1.8rem;
            font-weight: bold;
            display: block;
        }

        .stat-card-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .c-green {
            color: var(--green);
        }

        .c-orange {
            color: var(--orange);
        }

        .c-purple {
            color: var(--purple);
        }

        .c-pink {
            color: var(--pink);
        }

        .chart-container {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            height: 350px;
            position: relative;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .history-table th {
            text-align: left;
            color: var(--text-muted);
            padding: 10px;
            border-bottom: 1px solid var(--border);
        }

        .history-table td {
            padding: 15px 10px;
            border-bottom: 1px solid var(--border);
            color: var(--text);
        }

        .close-btn {
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 10px;
            width: 100%;
            border-radius: 6px;
        }

        .close-btn:hover {
            background: var(--border);
        }

        /* AI Config Form */
        .config-group {
            margin-bottom: 15px;
        }

        .config-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .config-select,
        .config-input {
            width: 100%;
            padding: 10px;
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 6px;
            box-sizing: border-box;
        }

        .help-box {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 0.85rem;
            color: var(--text);
            line-height: 1.5;
        }

        .help-box a {
            color: var(--accent);
        }

        /* About Modal Specifics */
        .about-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .about-card {
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 20px;
            border-radius: 12px;
            transition: transform 0.2s;
        }

        .about-card:hover {
            transform: translateY(-3px);
            border-color: var(--accent);
        }

        .about-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            display: block;
        }

        .about-h3 {
            margin: 0 0 10px 0;
            color: var(--text);
            font-size: 1.1rem;
            font-weight: bold;
        }

        .about-p {
            margin: 0;
            color: var(--text-muted);
            line-height: 1.5;
            font-size: 0.9rem;
        }

        /* --- POPUP --- */
        #selectionPopup {
            position: fixed;
            background: var(--bg);
            border: 1px solid var(--accent);
            padding: 5px;
            display: none;
            gap: 5px;
            z-index: 1000;
            border-radius: 6px;
        }

        #selectionPopup button {
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        #selectionPopup button:hover {
            background: var(--accent);
            color: white;
        }

        button.primary {
            background: var(--accent);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
        }

        .nav-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-muted);
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .nav-btn:hover {
            background: var(--hover-bg);
            color: var(--text);
        }
    </style>
</head>

<body>

    <div class="top-bar">
        <div class="controls-left">
            <h1 style="margin:0; font-size: 1.1rem;">Logseq to Anki</h1>
            <button class="primary" onclick="openGraphFolder()">üìÇ Select Graph Folder</button>
            <label class="toggle-switch">
                <input type="checkbox" id="smartScanToggle" checked onchange="renderCurrentFile()">
                <span>Suggestions</span>
            </label>
            <div id="statusBadge" class="status-badge">
                <div class="pulse"></div> <span id="statusText">No Graph</span>
            </div>
        </div>
        <div style="display:flex; gap:10px;">
            <button onclick="toggleTheme()" class="nav-btn" title="Toggle Theme" id="themeBtn">
                üåó Theme
            </button>
            <button onclick="document.getElementById('aboutModal').style.display='flex'" class="nav-btn">
                ‚ÑπÔ∏è About
            </button>
            <button onclick="openAIConfigModal()"
                style="background:transparent; border:1px solid #8b5cf6; color:#a78bfa; padding:6px 10px; border-radius:4px; font-size:0.85rem;">
                ‚ú® AI Setup
            </button>
            <button onclick="openStatsModal()" class="nav-btn">
                üìä View Stats
            </button>
        </div>
    </div>

    <div class="workspace">
        <div class="pane">
            <div class="pane-header">Pages & Journals</div>
            <div class="search-box">
                <div class="search-wrapper">
                    <span class="search-icon">üîç</span>
                    <input type="text" id="fileSearch" placeholder="Search pages..." onkeyup="filterFiles()">
                </div>
            </div>
            <div class="file-list" id="fileListArea">
                <div style="padding:15px; color:var(--text-muted); text-align:center;">Select folder to start.</div>
            </div>
        </div>

        <div class="pane">
            <div class="pane-header"><span id="currentFileName">No File</span></div>
            <div id="sourceWrapper">
                <div id="sourceEditor" contenteditable="false"></div>
            </div>
        </div>

        <div class="pane">
            <div class="pane-header">Staging</div>
            <div class="workbench-split">
                <div class="input-area">
                    <div
                        style="display:flex; gap:10px; align-items:center; margin-bottom:5px; justify-content: space-between;">
                        <span style="font-size:0.75rem; color:var(--text-muted); font-weight:bold;">AI TOOLS</span>
                        <div style="display:flex; gap:5px;">
                            <button class="btn-ai" onclick="generateAICard('single')"><span>‚ú® Single</span></button>
                            <button class="btn-ai" style="background: linear-gradient(135deg, #ec4899, #db2777);"
                                onclick="generateAICard('batch')"><span>üöÄ Batch (File)</span></button>
                        </div>
                    </div>
                    <textarea id="inputFront" placeholder="Front (Alt+1) - Or highlight text on left + AI Single"
                        spellcheck="true"></textarea>
                    <textarea id="inputBack" placeholder="Back (Alt+2)" spellcheck="true"></textarea>
                    <button class="btn-stage" onclick="stageDraft()"><span>‚¨á Stage</span>
                        <span>Ctrl+Enter</span></button>
                </div>
                <div class="pane-header"
                    style="background:transparent; border-top:none; border-bottom:1px solid var(--border); font-size:0.7rem;">
                    Pending
                    <button class="clear-btn" onclick="clearDrafts()" title="Clear Staging">üóëÔ∏è</button>
                </div>
                <div class="draft-area" id="draftList"></div>
                <div style="padding:10px; border-top: 1px solid var(--border); flex-shrink: 0;">
                    <button class="btn-commit-all" onclick="commitAllDrafts()">Commit All ‚ûî</button>
                </div>
            </div>
        </div>

        <div class="pane">
            <div class="pane-header">
                Export Queue
                <button class="clear-btn" onclick="clearQueue()" title="Clear Queue">üóëÔ∏è</button>
            </div>
            <div class="card-list" id="finalList"></div>
            <div style="padding:10px;">
                <button class="primary" style="width:100%" onclick="downloadCSV()">Download CSV</button>
            </div>
        </div>
    </div>

    <div class="footer-bar">
        <div class="stat-group">
            <div class="stat-item"><span class="stat-label">WORDS:</span><span class="stat-value"
                    id="statWords">0</span></div>
            <div class="stat-divider"></div>
            <div class="stat-item"><span class="stat-label">CHARS:</span><span class="stat-value"
                    id="statChars">0</span></div>
        </div>
        <div class="stat-group">
            <div class="stat-item"><span class="stat-label">DRAFTS:</span><span class="stat-value" id="statDrafts"
                    style="color:var(--orange)">0</span></div>
            <div class="stat-divider"></div>
            <div class="stat-item"><span class="stat-label" style="color:var(--green)">QUEUE:</span><span
                    class="stat-value" id="statTotal" style="color:var(--green)">0</span></div>
        </div>
    </div>

    <div id="aiConfigModal" class="modal-overlay">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <div class="modal-title">‚ú® AI Settings</div>
                <button onclick="document.getElementById('aiConfigModal').style.display='none'"
                    style="background:none; border:none; color:var(--text); font-size:1.5rem;">‚úï</button>
            </div>
            <div class="config-group">
                <label>Select Provider</label>
                <select id="aiProvider" class="config-select" onchange="updateAIHelp()">
                    <option value="gemini">Google Gemini (Free)</option>
                    <option value="openai">OpenAI ChatGPT (Paid)</option>
                </select>
            </div>
            <div class="config-group">
                <label>API Key</label>
                <input type="password" id="aiKeyInput" class="config-input" placeholder="sk-..."
                    onchange="handleKeyChange()" />
            </div>

            <div class="config-group" id="modelSelectGroup" style="display:none;">
                <label>Model Name</label>
                <div style="display:flex; gap:10px;">
                    <select id="aiModel" class="config-select">
                    </select>
                    <button onclick="checkGeminiConnection()"
                        style="background:#3b82f6; color:white; border:none; border-radius:4px; padding:0 10px; font-size:0.8rem; white-space:nowrap;">Refresh</button>
                </div>
            </div>

            <div id="aiHelpBox" class="help-box"></div>
            <div style="margin-top:20px;">
                <button class="primary" style="width:100%" onclick="saveAIConfig()">Save Configuration</button>
            </div>
        </div>
    </div>

    <div id="statsModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Community Statistics</div>
                <button onclick="document.getElementById('statsModal').style.display='none'"
                    style="background:none; border:none; color:var(--text); font-size:1.5rem;">‚úï</button>
            </div>
            <div class="stat-grid">
                <div class="stat-card">
                    <span class="stat-card-num c-green" id="modalTotalWords">0</span>
                    <span class="stat-card-label">Words Generated</span>
                </div>
                <div class="stat-card">
                    <span class="stat-card-num c-orange" id="modalTotalChars">0</span>
                    <span class="stat-card-label">Characters</span>
                </div>
                <div class="stat-card">
                    <span class="stat-card-num c-purple" id="modalTotalCards">0</span>
                    <span class="stat-card-label">Cards Created</span>
                </div>
                <div class="stat-card">
                    <span class="stat-card-num c-pink" id="modalTotalAI">0</span>
                    <span class="stat-card-label">AI Generated</span>
                </div>
            </div>
            <div class="chart-container"><canvas id="myChart"></canvas></div>
            <div style="margin-top: 20px;">
                <h3 style="margin-bottom: 15px; font-size: 1rem; color: var(--text-muted);">History by Month</h3>
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Month</th>
                            <th>Words</th>
                            <th>Characters</th>
                            <th>Cards</th>
                            <th>AI Gen</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody"></tbody>
                </table>
            </div>
            <button class="close-btn"
                onclick="document.getElementById('statsModal').style.display='none'">Close</button>
        </div>
    </div>

    <div id="aboutModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">About Logseq to Anki</div>
                <button onclick="document.getElementById('aboutModal').style.display='none'"
                    style="background:none; border:none; color:var(--text); font-size:1.5rem; cursor:pointer;">‚úï</button>
            </div>

            <div style="text-align:center; margin-bottom:40px;">
                <p style="font-size:1.1rem; color:var(--text-muted); line-height:1.6;">
                    A privacy-first tool designed to bridge the gap between your <br>
                    knowledge base and long-term memory.
                </p>
            </div>

            <div class="about-grid">
                <div class="about-card">
                    <span class="about-icon">üîí</span>
                    <h3 class="about-h3">Local & Secure</h3>
                    <p class="about-p">Built on the File System Access API. Your Logseq graph stays in your browser. No
                        personal notes are ever sent to a server (unless you explicitly send them to AI).</p>
                </div>
                <div class="about-card">
                    <span class="about-icon">üß†</span>
                    <h3 class="about-h3">Multimodal AI</h3>
                    <p class="about-p">Integrates with Google Gemini and OpenAI. The AI can read your text and "see"
                        your screenshots to generate high-quality flashcards automatically.</p>
                </div>
                <div class="about-card">
                    <span class="about-icon">‚ö°</span>
                    <h3 class="about-h3">Smart Workflow</h3>
                    <p class="about-p">Features an instant markdown preview, duplicate detection, and a staging area to
                        review cards before exporting them to Anki CSV.</p>
                </div>
                <div class="about-card">
                    <span class="about-icon">üìÇ</span>
                    <h3 class="about-h3">Graph Native</h3>
                    <p class="about-p">Reads your Logseq folder structure directly. Simply point it to your graph and
                        start searching your pages and journals immediately.</p>
                </div>
            </div>

            <div style="text-align:center; border-top:1px solid var(--border); padding-top:30px;">
                <a href="https://github.com/jackrschumacher/logseq-to-anki/issues" target="_blank" class="nav-btn"
                    style="display:inline-block; padding:10px 20px; border:1px solid var(--border); border-radius:6px; text-decoration:none; color:var(--text);">Report
                    Issue on GitHub</a>
                <div class="version" style="margin-top:20px; color:var(--text-muted); font-size:0.8rem;">Code generated
                    using generative AI</div>
            </div>
        </div>
    </div>

    <div id="selectionPopup">
        <button onclick="sendSelection('front')">Front</button>
        <button onclick="sendSelection('back')">Back</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getDatabase, ref, onValue, runTransaction, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        // --- KEYS ---
        const firebaseConfig = {
            apiKey: "AIzaSyAUioj0PYXuWnqN38g3oVvg-lP_r42c-fI",
            authDomain: "logseq-to-anki.firebaseapp.com",
            databaseURL: "https://logseq-to-anki-default-rtdb.firebaseio.com",
            projectId: "logseq-to-anki",
            storageBucket: "logseq-to-anki.firebasestorage.app",
            messagingSenderId: "210112636810",
            appId: "1:210112636810:web:f832c90ef178f3c5e14a73"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        let currentUser = null;
        let chartInstance = null;

        signInAnonymously(auth).catch((error) => console.error("Auth Failed", error));
        onAuthStateChanged(auth, (user) => { if (user) currentUser = user; });

        function getCurrentMonthKey() {
            const date = new Date();
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        }

        window.trackAIStats = function (count) {
            if (!currentUser || count <= 0) return;
            const monthKey = getCurrentMonthKey();
            const statsRef = ref(db, `global_stats/${monthKey}`);
            runTransaction(statsRef, (data) => {
                if (!data) return { cardCount: 0, wordCount: 0, charCount: 0, aiCount: count };
                return { ...data, aiCount: (data.aiCount || 0) + count };
            });
            const totalRef = ref(db, `global_totals`);
            runTransaction(totalRef, (data) => {
                if (!data) return { cardCount: 0, wordCount: 0, charCount: 0, aiCount: count };
                return { ...data, aiCount: (data.aiCount || 0) + count };
            });
        };

        window.saveBatchStats = function (cardCount, wordCount, charCount) {
            if (!currentUser || cardCount <= 0) return;
            const monthKey = getCurrentMonthKey();
            const statsRef = ref(db, `global_stats/${monthKey}`);
            runTransaction(statsRef, (data) => {
                if (!data) return { cardCount, wordCount, charCount, aiCount: 0 };
                return {
                    ...data,
                    cardCount: (data.cardCount || 0) + cardCount,
                    wordCount: (data.wordCount || 0) + wordCount,
                    charCount: (data.charCount || 0) + charCount
                };
            });
            const totalRef = ref(db, `global_totals`);
            runTransaction(totalRef, (data) => {
                if (!data) return { cardCount, wordCount, charCount, aiCount: 0 };
                return {
                    ...data,
                    cardCount: (data.cardCount || 0) + cardCount,
                    wordCount: (data.wordCount || 0) + wordCount,
                    charCount: (data.charCount || 0) + charCount
                };
            });
        };

        window.openStatsModal = async function () {
            if (!currentUser) { alert("Please wait for Firebase connection."); return; }
            document.getElementById('statsModal').style.display = 'flex';
            const historyPromise = get(ref(db, `global_stats`));
            const totalsPromise = get(ref(db, `global_totals`));
            let historySnap, totalsSnap;
            try { [historySnap, totalsSnap] = await Promise.all([historyPromise, totalsPromise]); } catch (e) { console.error(e); }

            let totalWords = 0, totalChars = 0, totalCards = 0, totalAI = 0;
            if (totalsSnap && totalsSnap.exists()) {
                const t = totalsSnap.val();
                totalWords = t.wordCount || 0; totalChars = t.charCount || 0;
                totalCards = t.cardCount || 0; totalAI = t.aiCount || 0;
            }

            const labels = [], wordData = [], cardData = [], tableRows = [];
            if (historySnap && historySnap.exists()) {
                const data = historySnap.val();
                const months = Object.keys(data).sort();
                let calcWords = 0, calcChars = 0, calcCards = 0, calcAI = 0;
                months.forEach(m => {
                    const entry = data[m];
                    calcWords += (entry.wordCount || 0); calcChars += (entry.charCount || 0);
                    calcCards += (entry.cardCount || 0); calcAI += (entry.aiCount || 0);
                    labels.push(m); wordData.push(entry.wordCount || 0); cardData.push(entry.cardCount || 0);
                    tableRows.unshift(`<tr>
                        <td>${m}</td>
                        <td style="color:#10b981">${(entry.wordCount || 0).toLocaleString()}</td>
                        <td style="color:#f59e0b">${(entry.charCount || 0).toLocaleString()}</td>
                        <td style="color:#8b5cf6">${(entry.cardCount || 0).toLocaleString()}</td>
                        <td style="color:#ec4899">${(entry.aiCount || 0).toLocaleString()}</td>
                    </tr>`);
                });
                if (!totalsSnap || !totalsSnap.exists()) {
                    totalWords = calcWords; totalChars = calcChars; totalCards = calcCards; totalAI = calcAI;
                }
            }
            document.getElementById('modalTotalWords').innerText = totalWords.toLocaleString();
            document.getElementById('modalTotalChars').innerText = totalChars.toLocaleString();
            document.getElementById('modalTotalCards').innerText = totalCards.toLocaleString();
            document.getElementById('modalTotalAI').innerText = totalAI.toLocaleString();
            document.getElementById('historyTableBody').innerHTML = tableRows.join('');
            renderChart(labels, wordData, cardData);
        };

        function renderChart(labels, wordData, cardData) {
            const ctx = document.getElementById('myChart').getContext('2d');
            const isLight = document.documentElement.getAttribute('data-theme') === 'light';
            const gridColor = isLight ? '#cbd5e1' : '#334155';
            const tickColor = isLight ? '#64748b' : '#94a3b8';

            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Words', data: wordData, backgroundColor: 'rgba(16, 185, 129, 0.7)', yAxisID: 'y' },
                        { label: 'Cards', data: cardData, borderColor: '#8b5cf6', backgroundColor: 'rgba(139, 92, 246, 0.2)', type: 'line', yAxisID: 'y1' }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { labels: { color: tickColor } } },
                    scales: {
                        x: { ticks: { color: tickColor }, grid: { color: gridColor } },
                        y: { type: 'linear', display: true, position: 'left', ticks: { color: '#10b981' }, grid: { color: gridColor } },
                        y1: { type: 'linear', display: true, position: 'right', ticks: { color: '#8b5cf6' }, grid: { drawOnChartArea: false } }
                    }
                }
            });
        }
    </script>

    <script>
        // --- THEME LOGIC ---
        // --- THEME LOGIC ---
        function toggleTheme() {
            const html = document.documentElement;
            if (html.getAttribute('data-theme') === 'light') {
                html.removeAttribute('data-theme');
                localStorage.setItem('theme', 'dark');
            } else {
                html.setAttribute('data-theme', 'light');
                localStorage.setItem('theme', 'light');
            }
        }

        (function () {
            const savedTheme = localStorage.getItem('theme');
            const systemLight = window.matchMedia('(prefers-color-scheme: light)').matches;
            if (savedTheme === 'light' || (!savedTheme && systemLight)) {
                document.documentElement.setAttribute('data-theme', 'light');
            } else {
                document.documentElement.removeAttribute('data-theme');
            }
            window.matchMedia('(prefers-color-scheme: light)').addEventListener('change', e => {
                if (!localStorage.getItem('theme')) {
                    e.matches ? document.documentElement.setAttribute('data-theme', 'light') : document.documentElement.removeAttribute('data-theme');
                }
            });
        })();

        let allFiles = [], currentFileHandle = null, lastModified = 0, watchInterval = null, currentRawText = "";
        let assetsMap = new Map();
        let drafts = [], cards = [];

        // --- HTML PREVIEW HELPER ---
        // This makes sure your web preview looks like Anki (Renders <b>, <i>, <sub>), 
        // but escapes malicious scripts.
        function safeRender(t) {
            if (!t) return "";
            let safe = t.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            return safe
                .replace(/&lt;b&gt;/g, "<b>").replace(/&lt;\/b&gt;/g, "</b>")
                .replace(/&lt;strong&gt;/g, "<b>").replace(/&lt;\/strong&gt;/g, "</b>")
                .replace(/&lt;i&gt;/g, "<i>").replace(/&lt;\/i&gt;/g, "</i>")
                .replace(/&lt;em&gt;/g, "<i>").replace(/&lt;\/em&gt;/g, "</i>")
                .replace(/&lt;u&gt;/g, "<u>").replace(/&lt;\/u&gt;/g, "</u>")
                .replace(/&lt;sub&gt;/g, "<sub>").replace(/&lt;\/sub&gt;/g, "</sub>")
                .replace(/&lt;sup&gt;/g, "<sup>").replace(/&lt;\/sup&gt;/g, "</sup>")
                .replace(/&lt;br&gt;/g, "<br>")
                .replace(/&lt;code&gt;/g, "<code>").replace(/&lt;\/code&gt;/g, "</code>");
        }

        async function openGraphFolder() {
            try {
                const dirHandle = await window.showDirectoryPicker();
                allFiles = []; assetsMap.clear(); let scanned = false;
                try { await scanDirectory(await dirHandle.getDirectoryHandle('pages', { create: false }), 'pages'); scanned = true; } catch (e) { }
                try { await scanDirectory(await dirHandle.getDirectoryHandle('journals', { create: false }), 'journals'); scanned = true; } catch (e) { }
                try { await scanAssets(await dirHandle.getDirectoryHandle('assets', { create: false })); } catch (e) { console.log("No assets folder found"); }
                if (!scanned) await scanDirectory(dirHandle, 'root');
                allFiles.sort((a, b) => a.name.localeCompare(b.name));
                renderFileList(allFiles);
                document.getElementById('statusBadge').classList.add('active');
                document.getElementById('statusText').innerText = "Graph Loaded";
            } catch (err) { console.error(err); alert("Browser requires permissions or folder is empty."); }
        }

        async function scanDirectory(h, f) {
            for await (const e of h.values()) if (e.kind === 'file' && e.name.endsWith('.md')) allFiles.push({ name: e.name, handle: e, folder: f });
        }

        async function scanAssets(h) {
            for await (const e of h.values()) {
                if (e.kind === 'file') {
                    assetsMap.set(decodeURIComponent(e.name), e);
                    assetsMap.set(e.name, e);
                }
            }
            console.log(`Loaded ${assetsMap.size} assets`);
        }

        function renderFileList(list) {
            const el = document.getElementById('fileListArea'); el.innerHTML = '';
            if (list.length === 0) return el.innerHTML = '<div style="padding:15px;color:var(--text-muted);">No .md files</div>';
            list.forEach(f => {
                const d = document.createElement('div'); d.className = 'file-item'; d.innerText = f.name;
                d.onclick = () => loadFile(f);
                if (currentFileHandle && currentFileHandle.name === f.name) d.classList.add('selected');
                el.appendChild(d);
            });
        }
        function filterFiles() {
            const q = document.getElementById('fileSearch').value.toLowerCase();
            renderFileList(allFiles.filter(f => f.name.toLowerCase().includes(q)));
        }

        async function loadFile(f) {
            currentFileHandle = f.handle; document.getElementById('currentFileName').innerText = f.name;
            filterFiles(); await loadContent();
            if (watchInterval) clearInterval(watchInterval);
            watchInterval = setInterval(checkChanges, 1000);
        }
        async function loadContent() {
            const f = await currentFileHandle.getFile(); lastModified = f.lastModified;
            currentRawText = await f.text(); renderCurrentFile(); updateStats();
        }
        async function checkChanges() {
            if (!currentFileHandle || !window.getSelection().isCollapsed) return;
            const f = await currentFileHandle.getFile(); if (f.lastModified > lastModified) await loadContent();
        }

        async function renderCurrentFile() {
            const ed = document.getElementById('sourceEditor');
            const wrap = document.getElementById('sourceWrapper');
            const top = wrap.scrollTop;
            let processedHtml = currentRawText.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");

            const imgRegex = /!\[.*?\]\((.*?)\)/g;
            const matches = [...processedHtml.matchAll(imgRegex)];

            for (const match of matches) {
                const fullTag = match[0];
                const path = match[1];
                const filename = decodeURIComponent(path.split('/').pop());
                if (assetsMap.has(filename)) {
                    try {
                        const file = await assetsMap.get(filename).getFile();
                        const url = URL.createObjectURL(file);
                        const imgTag = `<img src="${url}" data-filename="${filename}" title="${filename}">`;
                        processedHtml = processedHtml.replace(fullTag, imgTag);
                    } catch (e) { console.error("Error loading image", filename, e); }
                }
            }

            if (!document.getElementById('smartScanToggle').checked) {
                ed.innerHTML = processedHtml;
            } else {
                const lines = processedHtml.split('\n');
                ed.innerHTML = lines.map(l => {
                    if (l.trim().startsWith('<img')) return l;
                    const m = l.match(/^(\s*-\s*)?\*\*(.*?)\*\*[:?]?\s+(.*)$/);
                    if (m && m[3].trim().length > 0) return `<div class="auto-card" data-f="${escA(m[2])}" data-b="${escA(m[3])}">${l}</div>`;
                    return l.replace(/(\^\^.*?\^\^)/g, '<span class="suggestion" data-txt="$1">$1</span>')
                        .replace(/(\*\*.*?\*\*)/g, '<span class="suggestion" data-txt="$1">$1</span>');
                }).join('\n');

                document.querySelectorAll('.auto-card').forEach(e => e.onclick = (ev) => {
                    ev.stopPropagation();
                    setInputs(e.getAttribute('data-f').replace(/&quot;/g, '"'), e.getAttribute('data-b').replace(/&quot;/g, '"'));
                });
                document.querySelectorAll('.suggestion').forEach(e => e.onclick = (ev) => {
                    ev.stopPropagation(); showPop(e);
                });
            }
            wrap.scrollTop = top;
        }

        function stageDraft() {
            const f = document.getElementById('inputFront').value.trim();
            const b = document.getElementById('inputBack').value.trim();
            if (!f || !b) return;
            if (isDuplicate({ front: f, back: b })) {
                if (!confirm("This card (Front) already exists. Add anyway?")) return;
            }
            drafts.push({ front: f, back: b });
            document.getElementById('inputFront').value = ''; document.getElementById('inputBack').value = '';
            document.getElementById('inputFront').focus(); renderDrafts();
        }

        // UPDATED: Uses safeRender to show Bold/Sub/Sup correctly in web preview
        function renderDrafts() {
            const el = document.getElementById('draftList'); el.innerHTML = '';
            drafts.forEach((d, i) => {
                const div = document.createElement('div'); div.className = 'draft-item';
                div.innerHTML = `<b>${safeRender(d.front)}</b><br><span style="color:var(--text-muted)">${safeRender(d.back)}</span>
            <div class="draft-actions"><button class="mini-btn btn-del" onclick="drafts.splice(${i},1);renderDrafts()">Discard</button>
            <button class="mini-btn btn-push" onclick="cards.push(drafts[${i}]);drafts.splice(${i},1);renderDrafts();renderQueue()">Add ‚ûî</button></div>`;
                el.appendChild(div);
            });
            el.scrollTop = el.scrollHeight; updateStats();
        }

        function commitAllDrafts() { cards.push(...drafts); drafts = []; renderDrafts(); renderQueue(); }

        // UPDATED: Uses safeRender to show Bold/Sub/Sup correctly in web preview
        function renderQueue() {
            const el = document.getElementById('finalList'); el.innerHTML = '';
            cards.forEach((c, i) => {
                const div = document.createElement('div'); div.className = 'saved-card';
                div.innerHTML = `<b>${safeRender(c.front)}</b><br>${safeRender(c.back)}
            <button onclick="cards.splice(${i},1);renderQueue()" style="position:absolute;top:5px;right:5px;border:none;background:none;color:#ef4444;cursor:pointer;">‚úï</button>`;
                el.appendChild(div);
            });
            el.scrollTop = el.scrollHeight; updateStats();
        }

        window.clearDrafts = function () {
            if (drafts.length === 0) return;
            if (confirm("Clear all pending drafts?")) { drafts = []; renderDrafts(); }
        }
        window.clearQueue = function () {
            if (cards.length === 0) return;
            if (confirm("Clear export queue?")) { cards = []; renderQueue(); }
        }

        function downloadCSV() {
            if (cards.length === 0) return alert("Queue empty!");
            let defaultName = "anki_export.csv";
            if (currentFileHandle && currentFileHandle.name) defaultName = currentFileHandle.name.replace(/\.md$/i, '') + ".csv";

            let name = prompt("Exporting CSV. Rename if you like:", defaultName);
            if (!name) return;
            if (!name.toLowerCase().endsWith(".csv")) name += ".csv";

            let totalW = 0, totalC = 0;
            cards.forEach(c => {
                totalW += (c.front + " " + c.back).split(/\s+/).length;
                totalC += (c.front.length + c.back.length);
            });

            // Export logic: We do NOT escape HTML tags here (like <b>) because Anki needs them.
            // We only escape CSV special chars (double quotes).
            let csv = "#separator:Comma\n";
            cards.forEach(c => {
                let f = `"${c.front.replace(/"/g, '""').replace(/\n/g, '<br>')}"`;
                let b = `"${c.back.replace(/"/g, '""').replace(/\n/g, '<br>')}"`;
                csv += `${f},${b}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = name; link.click();
            if (window.saveBatchStats) window.saveBatchStats(cards.length, totalW, totalC);

            // Alert to remind user about Anki settings
            alert("Downloaded!\n\nIMPORTANT: When importing to Anki, make sure to check 'Allow HTML in fields' in the import settings.");
        }

        function updateStats() {
            const t = currentRawText || "";
            document.getElementById('statWords').innerText = t.trim() === "" ? 0 : t.trim().split(/\s+/).length.toLocaleString();
            document.getElementById('statChars').innerText = t.length.toLocaleString();
            document.getElementById('statDrafts').innerText = drafts.length;
            document.getElementById('statTotal').innerText = cards.length;
        }
        function setInputs(f, b) {
            const iF = document.getElementById('inputFront'); iF.value = f;
            document.getElementById('inputBack').value = b;
            iF.style.borderColor = '#10b981'; setTimeout(() => iF.style.borderColor = 'var(--border)', 300);
        }
        function showPop(el) {
            const p = document.getElementById('selectionPopup'); const r = el.getBoundingClientRect();
            p.style.display = 'flex'; p.style.top = (r.top - 40) + 'px'; p.style.left = r.left + 'px';
            const range = document.createRange(); range.selectNodeContents(el);
            window.getSelection().removeAllRanges(); window.getSelection().addRange(range);
        }
        function sendSelection(t) {
            const txt = window.getSelection().toString().trim().replace(/^\*\*|\*\*$/g, '').replace(/^\^\^|\^\^$/g, '');
            document.getElementById(t === 'front' ? 'inputFront' : 'inputBack').value = txt;
            document.getElementById('selectionPopup').style.display = 'none';
        }
        function esc(t) { return t.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }
        function escA(t) { return t.replace(/"/g, "&quot;"); }

        document.addEventListener('mouseup', e => {
            const s = window.getSelection();
            if (s.isCollapsed || !document.getElementById('sourceEditor').contains(s.anchorNode)) document.getElementById('selectionPopup').style.display = 'none';
            else showPop(s.getRangeAt(0));
        });
        document.addEventListener('keydown', e => {
            if (e.ctrlKey && e.key === 'Enter') { e.preventDefault(); stageDraft(); }
            if (e.altKey && e.key === '1') { e.preventDefault(); sendSelection('front'); }
            if (e.altKey && e.key === '2') { e.preventDefault(); sendSelection('back'); }
        });

        let aiConfig = {
            provider: localStorage.getItem('ai_provider') || 'gemini',
            geminiKey: localStorage.getItem('gemini_key') || "",
            openAIKey: localStorage.getItem('openai_key') || "",
            geminiModel: localStorage.getItem('gemini_model') || 'gemini-1.5-flash',
            openAIModel: localStorage.getItem('openai_model') || 'gpt-4o-mini'
        };

        window.handleKeyChange = function () {
            if (aiConfig.provider === 'gemini') checkGeminiConnection();
        }

        window.openAIConfigModal = function () {
            document.getElementById('aiConfigModal').style.display = 'flex';
            document.getElementById('aiProvider').value = aiConfig.provider;
            const currentKey = aiConfig.provider === 'gemini' ? aiConfig.geminiKey : aiConfig.openAIKey;
            document.getElementById('aiKeyInput').value = currentKey;
            const modelGroup = document.getElementById('modelSelectGroup');
            if (currentKey) {
                modelGroup.style.display = 'block';
                populateDefaultModels(aiConfig.provider);
                if (aiConfig.provider === 'gemini') checkGeminiConnection();
            } else {
                modelGroup.style.display = 'none';
            }
            updateAIHelp();
        };

        function populateDefaultModels(provider) {
            const select = document.getElementById('aiModel');
            const currentSelection = select.value || (provider === 'gemini' ? aiConfig.geminiModel : aiConfig.openAIModel);
            select.innerHTML = '';
            let defaults = provider === 'gemini'
                ? ['gemini-1.5-flash', 'gemini-1.5-pro', 'gemini-2.0-flash-exp']
                : ['gpt-4o', 'gpt-4o-mini', 'gpt-4-turbo'];

            defaults.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m; opt.text = m + (m === currentSelection ? ' (Saved)' : '');
                if (m === currentSelection) opt.selected = true;
                select.add(opt);
            });
        }

        window.updateAIHelp = function () {
            const provider = document.getElementById('aiProvider').value;
            const helpBox = document.getElementById('aiHelpBox');
            const modelGroup = document.getElementById('modelSelectGroup');
            populateDefaultModels(provider);
            if (provider === 'gemini') {
                helpBox.innerHTML = `<strong>Get a Free Google Gemini API Key:</strong><br>1. Go to <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a>.<br>2. Click "Create API Key" (New Project).`;
            } else {
                helpBox.innerHTML = `<strong>Get an OpenAI API Key:</strong><br>1. Go to <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI Platform</a>.`;
            }
            const currentStored = provider === 'gemini' ? aiConfig.geminiKey : aiConfig.openAIKey;
            document.getElementById('aiKeyInput').value = currentStored;
            if (currentStored) modelGroup.style.display = 'block'; else modelGroup.style.display = 'none';
        };

        window.checkGeminiConnection = async function () {
            const provider = document.getElementById('aiProvider').value;
            const key = document.getElementById('aiKeyInput').value.trim();
            const select = document.getElementById('aiModel');
            if (!key || provider !== 'gemini') return;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                select.innerHTML = '';
                const models = data.models.filter(m => m.supportedGenerationMethods && m.supportedGenerationMethods.includes("generateContent"));
                models.sort((a, b) => (a.name.includes('flash') ? -1 : 1));
                models.forEach(m => {
                    const name = m.name.replace('models/', '');
                    const opt = document.createElement('option');
                    opt.value = name; opt.text = name;
                    if (name === aiConfig.geminiModel) opt.selected = true;
                    select.add(opt);
                });
            } catch (e) { console.error(e); populateDefaultModels('gemini'); }
        };

        window.saveAIConfig = function () {
            const provider = document.getElementById('aiProvider').value;
            const key = document.getElementById('aiKeyInput').value.trim();
            const model = document.getElementById('aiModel').value;
            if (!key) { alert("Please enter an API Key."); return; }
            aiConfig.provider = provider;
            localStorage.setItem('ai_provider', provider);
            if (provider === 'gemini') {
                aiConfig.geminiKey = key; aiConfig.geminiModel = model;
                localStorage.setItem('gemini_key', key); localStorage.setItem('gemini_model', model);
            } else {
                aiConfig.openAIKey = key; aiConfig.openAIModel = model;
                localStorage.setItem('openai_key', key); localStorage.setItem('openai_model', model);
            }
            document.getElementById('aiConfigModal').style.display = 'none';
            alert(`Saved! Using ${provider} (${model}).`);
        };

        function isDuplicate(newCard) {
            const isRef = (c) => c.front.trim() === newCard.front.trim();
            return drafts.some(isRef) || cards.some(isRef);
        }

        async function fileToGenericBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        window.generateAICard = async function (mode) {
            const btn = document.querySelectorAll('.btn-ai')[mode === 'single' ? 0 : 1];
            const frontEl = document.getElementById('inputFront');
            const backEl = document.getElementById('inputBack');

            let textToProcess = "";
            if (mode === 'single') {
                textToProcess = window.getSelection().toString().trim();
                if (!textToProcess) textToProcess = frontEl.value.trim();
                if (!textToProcess) { alert("Please select text or type in Front box."); return; }
            } else {
                textToProcess = currentRawText;
                if (!textToProcess) { alert("No file content loaded."); return; }
            }

            const imgRegex = /!\[.*?\]\((.*?)\)/g;
            const imgMatches = [...textToProcess.matchAll(imgRegex)];
            let imagesToSend = [];

            for (let i = 0; i < Math.min(imgMatches.length, 5); i++) {
                const filename = decodeURIComponent(imgMatches[i][1].split('/').pop());
                if (assetsMap.has(filename)) {
                    try {
                        const file = await assetsMap.get(filename).getFile();
                        const b64 = await fileToGenericBase64(file);
                        imagesToSend.push({ mime: file.type || 'image/png', data: b64 });
                    } catch (e) { console.error("Could not process image for AI", filename); }
                }
            }

            const activeKey = aiConfig.provider === 'gemini' ? aiConfig.geminiKey : aiConfig.openAIKey;
            if (!activeKey) { openAIConfigModal(); return; }

            btn.classList.add('loading');
            const originalBtnText = btn.innerHTML;
            btn.innerHTML = `<span class="spinner"></span> <span id="aiBtnText">Processing...</span><div id="aiProgressBar" class="ai-progress-bar"></div>`;
            const progressBar = document.getElementById('aiProgressBar');

            let progress = 5;
            const progressInterval = setInterval(() => {
                if (progress < 90) progress += (90 - progress) * 0.1;
                if (progressBar) progressBar.style.width = `${progress}%`;
            }, 800);

            try {
                const modelId = aiConfig.provider === 'gemini' ? aiConfig.geminiModel : aiConfig.openAIModel;

                // --- UPDATED PROMPT: STERN WARNING AGAINST IMAGES AND MARKDOWN ---
                const instructions = `Use HTML tags (<b>, <i>, <u>, <sub>, <sup>, <br>, <code>) for formatting. 
            DO NOT use Markdown syntax (like ** or ##). 
            DO NOT output <img> tags or references to image files. Describe any images in text form.`;

                const systemPrompt = mode === 'single'
                    ? `Create ONE Anki flashcard. JSON only {"front": "...", "back": "..."}. ${instructions} Input: "${textToProcess}"`
                    : `Create flashcards JSON Array [{"front": "...", "back": "..."}, ...]. ${instructions} Input: "${textToProcess.substring(0, 30000)}"`;

                let rawResponse = "";

                if (aiConfig.provider === 'gemini') {
                    const parts = [{ text: systemPrompt }];
                    imagesToSend.forEach(img => {
                        parts.push({ inline_data: { mime_type: img.mime, data: img.data } });
                    });

                    const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelId}:generateContent?key=${activeKey}`;
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: parts }] })
                    });
                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);

                    const rawText = data.candidates[0].content.parts[0].text;
                    rawResponse = rawText.replace(/```json/g, '').replace(/```/g, '').trim();

                } else {
                    const contentArr = [{ type: "text", text: systemPrompt }];
                    imagesToSend.forEach(img => {
                        contentArr.push({ type: "image_url", image_url: { url: `data:${img.mime};base64,${img.data}` } });
                    });

                    const url = `https://api.openai.com/v1/chat/completions`;
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${activeKey}` },
                        body: JSON.stringify({ model: modelId, messages: [{ role: "user", content: contentArr }] })
                    });
                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);
                    rawResponse = data.choices[0].message.content.replace(/```json/g, '').replace(/```/g, '').trim();
                }

                // --- SANITIZATION: FORCE REMOVE IMG TAGS ---
                // Even if the AI disobeys, we strip the tags here.
                const stripImgs = (str) => str ? str.replace(/<img[^>]*>/gi, "[Image described above]") : "";

                if (mode === 'single') {
                    const card = JSON.parse(rawResponse);
                    card.front = stripImgs(card.front);
                    card.back = stripImgs(card.back);
                    if (isDuplicate(card)) throw new Error("Duplicate card.");
                    frontEl.value = card.front; backEl.value = card.back;
                    if (window.trackAIStats) window.trackAIStats(1);
                } else {
                    const cardsGenerated = JSON.parse(rawResponse);
                    let added = 0;
                    if (Array.isArray(cardsGenerated)) {
                        cardsGenerated.forEach(c => {
                            c.front = stripImgs(c.front);
                            c.back = stripImgs(c.back);
                            if (!isDuplicate(c)) { drafts.push(c); added++; }
                        });
                        renderDrafts();
                        alert(`Generated ${added} cards.`);
                        if (window.trackAIStats) window.trackAIStats(added);
                    }
                }
                if (progressBar) progressBar.style.width = '100%';
                await new Promise(r => setTimeout(r, 200));

            } catch (err) {
                console.error(err);
                alert("AI Error: " + err.message);
            } finally {
                clearInterval(progressInterval);
                btn.classList.remove('loading');
                btn.innerHTML = originalBtnText;
            }
        };
    </script>
</body>

</html>